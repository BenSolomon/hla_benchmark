---
title: "1) Genotyping Accuracy"
output: html_notebook
---

# Setup 
```{r, message=F}
library(tidyverse)
library(ggh4x)
library(patchwork)
source("data_import_functions.R")
source("ggplot_layouts.R")
source("accuracy_functions.R")
isb_path <- "/labs/khatrilab/solomonb/covid/isb"
isb_samples <- read_tsv("/labs/khatrilab/solomonb/covid/isb/logs/210217_232725/parallel.log") %>% 
  separate(Command, into = c(NA, "sample"), sep = " ") %>% 
  pull(sample) %>% unique()
```

```{r}
all_hla <- format_hla_table(combine_HLA_import(path = isb_path, samples = isb_samples, expand_invitro = T))
```


# Calculations

### Prediction frequency

```{r}
prediction_frequency <- all_hla %>% 
  select(-allele_id) %>% 
  pivot_longer(cols = field_1:field_3, names_to = "field", values_to = "allele") %>% 
  pivot_wider(names_from = "genotyper", values_from = "allele", values_fn = function(x) sum(!is.na(x)), values_fill = 0) %>% 
  # filter(invitro != 0) %>% 
  ### NEED TO DEAL WITH HLAMINER AMBIGOUS ALLELES
  # mutate_at(vars(arcasHLA:hlaminer), funs(./invitro)) %>% 
  mutate_at(vars(arcasHLA:hlaminer), funs(./2)) %>% 
  select(-invitro) %>% 
  ungroup() %>% 
  pivot_longer(cols = arcasHLA:hlaminer, names_to = "genotyper", values_to = "frequency")

```

### Updated accuracy with expanded HLA

```{r, fig.height=8}
### Every subject has molecular HLA typing, but may occur in the BL, AC, or CV timepoint
### This expands the molecular HLA typing from the timepoint it occurs to all other time points 
### This allows for scRNA genotyping from a given subject and timepoint to be assessed even if that
### subjects molecular typing happened at a different time point. Since HLA is genetic, the molecular
### typing should not change
original <- format_hla_table(combine_HLA_import(path = isb_path, samples = isb_samples, expand_invitro = F))
expanded <- format_hla_table(combine_HLA_import(path = isb_path, samples = isb_samples, expand_invitro = T))

original <- compare_hla(hla_df = original, reference = "invitro", exclude_missing = F, compare_function = "accuracy")
expanded <- compare_hla(hla_df = expanded, reference = "invitro", exclude_missing = F, compare_function = "accuracy")


p1 <- original %>% 
  filter(grepl("^[ABC]", locus)) %>% 
  gg_accuracy() +
  ggtitle("MHC1 loci accuracy", subtitle = "Original in vitro vs. sample pairing")
p2 <- expanded %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^[ABC]", locus)) %>% 
  gg_accuracy() +
  ggtitle("MHC1 loci accuracy", subtitle = "Expanded HLA invitro vs. sample pairings. BL only")
p1/p2
```




### Success
```{r}
success_df <- compare_hla(hla_df = all_hla, 
            reference = "invitro", 
            exclude_missing = T, 
            compare_function = "accuracy") 
```

### Accuracy

```{r,message = F, warning=F}
accuracy_df <- compare_hla(hla_df = all_hla, 
            reference = "invitro", 
            exclude_missing = F, 
            compare_function = "accuracy") 
```

# Plotting

### Frequency

```{r, fig.width = 4, fig.height = 6}
c1_f <- prediction_frequency  %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^[ABC]", locus)) %>% 
  gg_frequency()
c1_f
```

```{r, fig.width = 8, fig.height = 6}
dp <- prediction_frequency %>% 
    filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DP", locus) & genotyper %in% c("arcasHLA", "hlaminer"),) %>% 
  gg_frequency()

dq <- prediction_frequency %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DQ", locus) & genotyper %in% c("arcasHLA", "hlaminer", "phlat"),) %>% 
  gg_frequency()

dra <- prediction_frequency %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DRA", locus) & genotyper %in% c("arcasHLA", "hlaminer"),) %>% 
  gg_frequency()

drb1 <- prediction_frequency %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DRB1", locus) & genotyper %in% c("arcasHLA", "hlaminer", "phlat"),) %>% 
  gg_frequency()

drb345 <- prediction_frequency %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DRB[345]", locus) & genotyper %in% c("arcasHLA", "hlaminer"),) %>% 
  gg_frequency()

c2_f <- dp|
  strip_y(dq)|
  strip_y(dra)|
  strip_y(drb1)|
  strip_y(drb345)|
  plot_layout(widths = c(6,6,3,3,9))

c2_f
```

### Success

```{r, fig.width = 4, fig.height = 6}
c1_s <- success_df%>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^[ABC]", locus)) %>% 
  mutate(genotyper = fct_relevel(genotyper, "arcasHLA", "phlat", "optitype", "hlaminer")) %>% 
  gg_accuracy() +
  ylab("Success")
c1_s
```


```{r, fig.width = 8, fig.height = 6}
dp_s <- success_df %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DP", locus) & genotyper %in% c("arcasHLA", "hlaminer"),) %>% 
  gg_accuracy()

dq_s <- success_df %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DQ", locus) & genotyper %in% c("arcasHLA", "hlaminer", "phlat"),) %>% 
  gg_accuracy()

# dra_a <- success_df %>% 
#   filter(grepl("^DRA", locus) & genotyper %in% c("arcasHLA", "hlaminer"),) %>% 
#   gg_accuracy()

drb1_s <- success_df %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DRB1", locus) & genotyper %in% c("arcasHLA", "hlaminer", "phlat"),) %>% 
  gg_accuracy()

drb345_s <- success_df %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DRB[345]", locus) & genotyper %in% c("arcasHLA", "hlaminer"),) %>% 
  gg_accuracy()

c2_s <- dp_s+ylab("Success")|
  strip_y(dq_s)|
  # strip_y(dra_s)|
  strip_y(drb1_s)|
  strip_y(drb345_s)|
  plot_layout(widths = c(6,6,3,9))
c2_s
```

### Accuracy

```{r, fig.width = 4, fig.height = 6}
c1_a <- accuracy_df%>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^[ABC]", locus)) %>% 
  gg_accuracy()
c1_a
```

```{r, fig.width = 8, fig.height = 6}
dp_a <- accuracy_df %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DP", locus) & genotyper %in% c("arcasHLA", "hlaminer"),) %>% 
  gg_accuracy()

dq_a <- accuracy_df %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DQ", locus) & genotyper %in% c("arcasHLA", "hlaminer", "phlat"),) %>% 
  gg_accuracy()

# dra_a <- accuracy_df %>% 
#   filter(grepl("^DRA", locus) & genotyper %in% c("arcasHLA", "hlaminer"),) %>% 
#   gg_accuracy()

drb1_a <- accuracy_df %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DRB1", locus) & genotyper %in% c("arcasHLA", "hlaminer", "phlat"),) %>% 
  gg_accuracy()

drb345_a <- accuracy_df %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^DRB[345]", locus) & genotyper %in% c("arcasHLA", "hlaminer"),) %>% 
  gg_accuracy()

c2_a <- dp_a|
  strip_y(dq_a)|
  # strip_y(dra_a)|
  strip_y(drb1_a)|
  strip_y(drb345_a)|
  plot_layout(widths = c(6,6,3,9))
c2_a
```

# Full figure

```{r, fig.width = 12, fig.height = 12}
(c1_f | c2_f | plot_layout(widths = c(3,11))) /
  (c1_s | c2_s | plot_layout(widths = c(3,11))) /
  (c1_a | c2_a | plot_layout(widths = c(3,11)))
```

