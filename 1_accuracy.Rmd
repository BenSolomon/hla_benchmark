---
title: "1) Genotyping Accuracy"
output: html_notebook
---

# Setup 
```{r, message=F}
library(tidyverse)
library(ggh4x)
library(cowplot)
source("data_import_functions.R")
source("ggplot_layouts.R")
source("figure_format_functions.R")
source("calculation_functions.R")
isb_path <- "/labs/khatrilab/solomonb/covid/isb"
isb_samples <- read_tsv("/labs/khatrilab/solomonb/covid/isb/logs/210217_232725/parallel.log") %>% 
  separate(Command, into = c(NA, "sample"), sep = " ") %>% 
  pull(sample) %>% unique()
```

```{r}
all_hla <- format_hla_table(combine_HLA_import(path = isb_path, samples = isb_samples, expand_invitro = T))
```


# Calculations

### Prediction tally

```{r}
prediction_tally <- all_hla %>% 
  allele_tally() %>% 
  filter(genotyper != "invitro", !grepl("DRB[345]", locus))
```

### Updated accuracy with expanded HLA

```{r, fig.height=8}
### Every subject has molecular HLA typing, but may occur in the BL, AC, or CV timepoint
### This expands the molecular HLA typing from the timepoint it occurs to all other time points 
### This allows for scRNA genotyping from a given subject and timepoint to be assessed even if that
### subjects molecular typing happened at a different time point. Since HLA is genetic, the molecular
### typing should not change
original <- format_hla_table(combine_HLA_import(path = isb_path, samples = isb_samples, expand_invitro = F))
expanded <- format_hla_table(combine_HLA_import(path = isb_path, samples = isb_samples, expand_invitro = T))

original <- compare_hla(hla_df = original, reference = "invitro", exclude_missing = F, compare_function = "accuracy")
expanded <- compare_hla(hla_df = expanded, reference = "invitro", exclude_missing = F, compare_function = "accuracy")


p1 <- original %>% 
  filter(grepl("^[ABC]", locus)) %>% 
  gg_accuracy() +
  ggtitle("MHC1 loci accuracy", subtitle = "Original in vitro vs. sample pairing")
p2 <- expanded %>% 
  filter(grepl("BL$", sample)) %>% 
  filter(grepl("^[ABC]", locus)) %>% 
  gg_accuracy() +
  ggtitle("MHC1 loci accuracy", subtitle = "Expanded HLA invitro vs. sample pairings. BL only")
p1/p2
```




### Success
```{r}
success_df <- compare_hla(hla_df = all_hla, 
            reference = "invitro", 
            exclude_missing = T, 
            compare_function = "accuracy") 
```

### Accuracy

```{r,message = F, warning=F}
accuracy_df <- compare_hla(hla_df = all_hla, 
            reference = "invitro", 
            exclude_missing = F, 
            compare_function = "accuracy") 
```

# Plotting

### Predicition tally

```{r, fig.width = 5, fig.height = 8}
predictions_plt <- gg_hla_prediction_tally(prediction_tally)
predictions_plt
```
### Success

```{r, fig.width = 5, fig.height = 4}
success_plt <- calculate_summary_df(success_df) %>% 
  gg_summary_hla_accuracy(color_label = "Success")
success_plt
```


### Accuracy

```{r, fig.width = 5, fig.height = 4}
accuracy_plt <- calculate_summary_df(accuracy_df) %>% 
  gg_summary_hla_accuracy(color_label = "Accuracy")
accuracy_plt
```

# Full figure

```{r,fig.height = 6, fig.width = 8}
plt_heatmaps <- plot_grid(
  success_plt,
  accuracy_plt,
  ncol = 1,
  labels = c("B","C")
)
plot_grid(
  predictions_plt,
  plt_heatmaps,
  labels = c("A",NA)
)
```

# Accuracy table

```{r, fig.width = 12}
calculate_summary_df(accuracy_df) %>% 
  flex_summary_hla_accuracy() %>% 
  fontsize(size = 8, part = "all") %>% 
  print(preview = "pptx")
```

```{r}
calculate_summary_df(success_df) %>% 
  flex_summary_hla_accuracy() %>% 
  fontsize(size = 8, part = "all") %>% 
  print(preview = "pptx")
```


# Accuracy by allele

```{r, fig.width = 16, fig.height = 8}
gg_allele_hla_accuracy(accuracy_df)
```

# Accuracy by individual

